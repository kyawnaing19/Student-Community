<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comment System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .comment-container {
            max-width: 600px;
            height: 520px; /* Adjust height to make room for sticky comment box */
            width: 100%;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto; /* Enable scrolling */
        }

        .comment-box {
            width: calc(100% - 40px);
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-top: 1px solid #e0e0e0;
            box-sizing: border-box;
            position: fixed; /* Make it sticky */
            bottom: 20px; /* Space from the bottom */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .comment-box textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            resize: none;
            font-size: 14px;
            box-sizing: border-box;
        }

        .comment-box button {
            align-self: flex-end;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        .comment-box button:hover {
            background-color: #0056b3;
        }

        .comments-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .comment-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            position: relative;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .comment-item p {
            margin: 0;
            font-size: 14px;
        }

        .comment-item button {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
            padding: 0;
            text-decoration: underline;
        }

        .comment-item button:hover {
            color: #0056b3;
        }

        .reply-box {
            margin-top: 10px;
            padding-left: 20px;
            border-left: 2px solid #e0e0e0;
            display: none;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .reply-box textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            resize: none;
            font-size: 14px;
            box-sizing: border-box;
        }

        .reply-box button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
        }

        .reply-box button:hover {
            background-color: #218838;
        }

        .reply-box .close-btn {
            background-color: transparent;
            color: #999;
            border: none;
            font-size: 16px;
            cursor: pointer;
            float: right;
            margin-bottom: 10px;
        }

        .replies-list {
            list-style: none;
            padding-left: 20px;
            margin-top: 10px;
        }

        .reply-item {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 5px;
            background-color: #f1f1f1;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .reply-item p {
            margin: 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="comment-container">
        <ul id="commentsList" class="comments-list"></ul>
    </div>
    <div class="comment-box">
        <textarea id="mainComment" rows="3" placeholder="Write a comment..."></textarea>
        <button onclick="addMainComment()">Add Comment</button>
    </div>
    <script src="../assests/js/jquery.min.js"></script>
    <script>
        let id=sessionStorage.getItem("id");
        let pId='[[${cid}]]';
        let user=sessionStorage.getItem("username");



        let commentsData = {};

        function addComment(parentId = null,profilename,commentText) {
            let aaa=document.querySelectorAll('.reply-box');
            aaa.forEach(element => {
    element.style.display = 'none';
});
            // const commentText = parentId ? document.getElementById(`replyComment${parentId}`).value : document.getElementById('mainComment').value;
            // if (commentText.trim() === '') return;

            const commentItem = document.createElement('li');
            commentItem.className = parentId ? 'reply-item' : 'comment-item';
            const uniqueId = parentId;
            commentsData[uniqueId] = parentId ? parentId : 'main';
            commentItem.innerHTML = `
                <h3>${name}</h3>
                ${profilename ==null ? ``: `<h5>${profilename}</h5>`}
                <p>${commentText}</p>
                <button onclick="showReplyBox(${uniqueId})">Reply</button>
                <div id="replyBox${uniqueId}" class="reply-box">
                    <button class="close-btn" onclick="hideReplyBox(${uniqueId})">x</button>
                    <textarea id="replyComment${uniqueId}" rows="2" placeholder="Write a reply..."></textarea>
                    <button onclick="test(${uniqueId},pId,'${name}')">Add Reply</button>
                </div>
            `;

            if (parentId) {
                const parentMainId = getParentMainId(parentId);
                const parentRepliesList = document.getElementById(`repliesList${parentMainId}`);
                parentRepliesList.appendChild(commentItem);
                document.getElementById(`replyComment${parentId}`).value = '';
                hideReplyBox(parentId);
                scrollToCommentBox();
            } else {
                commentItem.innerHTML += `<ul id="repliesList${uniqueId}" class="replies-list"></ul>`;
                document.getElementById('commentsList').appendChild(commentItem);
                document.getElementById('mainComment').value = '';
                scrollToCommentBox();
            }
            // $.get('/comments/addComment', { userId: userId, postId:postId }, function(response) {
            //
            //     $('#LikeIcon-'+postId+'').attr('class','fa-brands fa-gratipay');
            //     $('#Like-'+postId+'').attr('onclick','deleteLike('+userId+','+postId+')');
            //
            // }).fail(function(xhr, status, error) {
            //     alert('Request failed: ' + error);
            // });
        }

        function showReplyBox(commentId) {
            console.log("reply clicked")
            let aaa=document.querySelectorAll('.reply-box');
            aaa.forEach(element => {
    element.style.display = 'none';
});
            const replyBox = document.getElementById(`replyBox${commentId}`);
            replyBox.style.display = 'block';
            scrollToCommentBox();
        }

        function hideReplyBox(commentId) {
            const replyBox = document.getElementById(`replyBox${commentId}`);
            replyBox.style.display = 'none';
        }

        function scrollToCommentBox() {
            const commentBox = document.querySelector('.comment-box');
            commentBox.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function getParentMainId(commentId) {
            while (commentsData[commentId] !== 'main') {
                commentId = commentsData[commentId];
            }
            return commentId;
        }


        function test(current,pid,username){
            let content=document.getElementById("replyComment"+current).value;
            $.get('/comments/addComment', { postId: pid, content:content, parentComId:current, userId:id }, function(response) {
                console.log("user "+user);
                addCommentInLoop(current,content,response.id,username,user);

            }).fail(function(xhr, status, error) {
                alert('Request failed: ' + error);
            });
        }


        $.get('/comments/getComments', { postId: pId }, function(response) {
            if (Array.isArray(response) && response.length>0 ) {

                response.forEach(function(data){

                        addCommentInLoop(null,data.content,data.id,null,data.username);
                        processReplies(data.id,data.replies,data.username);



                });
            } else {
                console.log('Response is not an array:', response);
            }
        }).fail(function(xhr, status, error) {
            alert('Request failed: ' + error);
        });






        function addCommentInLoop(parentId = null,comment,cid,username,profilename) {
            let aaa=document.querySelectorAll('.reply-box');
            aaa.forEach(element => {
                element.style.display = 'none';
            });
            // const commentText = parentId ? document.getElementById(`replyComment${parentId}`).value : document.getElementById('mainComment').value;
            // if (commentText.trim() === '') return;

            const commentItem = document.createElement('li');
            commentItem.className = parentId ? 'reply-item' : 'comment-item';

            commentsData[cid] = parentId ? parentId : 'main';
            commentItem.innerHTML = `
                <h3>${profilename}</h3>
                ${username ==null ? ``: `<h5>${username}</h5>`}
                <p>${comment}</p>
                <button onclick="showReplyBox(${cid})">Reply</button>
                <div id="replyBox${cid}" class="reply-box">
                    <button class="close-btn" onclick="hideReplyBox(${cid})">x</button>
                    <textarea parentId="${cid}" id="replyComment${cid}" rows="2" placeholder="Write a reply..."></textarea>
                    <button onclick="test(${cid},pId,'${profilename}')">Add Reply</button>
                </div>
            `;

            if (parentId) {
                const parentMainId = getParentMainId(parentId);
                const parentRepliesList = document.getElementById(`repliesList${parentMainId}`);
                parentRepliesList.appendChild(commentItem);
                document.getElementById(`replyComment${parentId}`).value = '';
                hideReplyBox(parentId);
                scrollToCommentBox();
            } else {
                commentItem.innerHTML += `<ul id="repliesList${cid}" class="replies-list"></ul>`;
                document.getElementById('commentsList').appendChild(commentItem);
                document.getElementById('mainComment').value = '';
                scrollToCommentBox();
            }
        }

        function processReplies(id,data,username) {
            console.log("iddd"+id);
            console.log("aaa"+data);
            data.forEach(reply => {
                // console.log('ID:', reply.id);
                addCommentInLoop(id,reply.content,reply.id,username,reply.username);
                // console.log('CreatedAt:', reply.createdAt);

                if (reply.replies && reply.replies.length > 0) {
                    processReplies(reply.id, reply.replies,reply.username);
                }
            });
        }

        function addMainComment(){
            let cid;
            let aaa=document.querySelectorAll('.reply-box');
            aaa.forEach(element => {
                element.style.display = 'none';
            });
            const commentText =  document.getElementById('mainComment').value;
            if (commentText.trim() === '') return;
            $.get('/comments/addComment', { postId: pId, content:commentText, parentComId:0, userId:id }, function(response) {
                cid=response.id;
                const commentItem = document.createElement('li');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `
                <h3>${user}</h3>
                <p>${commentText}</p>

                <button onclick="showReplyBox(${cid})">Reply</button>
                <div id="replyBox${cid}" class="reply-box">
                    <button class="close-btn" onclick="hideReplyBox(${cid})">x</button>
                    <textarea id="replyComment${cid}" rows="2" placeholder="Write a reply..."></textarea>
                    <button onclick="test(${cid},pId,user)">Add Reply</button>
                </div>
            `;
                commentItem.innerHTML += `<ul id="repliesList${cid}" class="replies-list"></ul>`;
                document.getElementById('commentsList').appendChild(commentItem);
                document.getElementById('mainComment').value = '';
                scrollToCommentBox();

            }).fail(function(xhr, status, error) {
                alert('Request failed: ' + error);
            });

        }

        // data.forEach(item => {
        //     console.log('ID:', item.id);
        //     console.log('Content:', item.content);
        //     console.log('CreatedAt:', item.createdAt);
        //
        //     if (item.replies && item.replies.length > 0) {
        //         processReplies(item.replies);
        //     }
        // });

    </script>

</body>
</html>
